
name: MLOps CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  build-train:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
      AZURE_WORKSPACE_NAME: ${{ secrets.AZURE_WORKSPACE_NAME }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      AZURE_SAS_TOKEN: ${{ secrets.AZURE_SAS_TOKEN }}  # ðŸ”‘ SAS Token seguro
      AZURE_ACCOUNT_NAME: ${{ secrets.AZURE_ACCOUNT_NAME }}

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install azureml-core azureml-mlflow mlflow dvc[azure]

    - name: Configure DVC Azure remote with SAS Token
      run: |
        # Configura el remoto para usar SAS Token
        dvc remote modify azure account_name $AZURE_ACCOUNT_NAME
        dvc remote add -d azure azure://mlops-trabajo-final --force
        dvc remote modify azure sas_token "$AZURE_SAS_TOKEN"

    - name: Pull data from Azure
      run: dvc pull

    - name: Reproduce pipeline
      run: dvc repro

    - name: Train and log in MLflow (Azure ML backend)
      run: python src/train.py

    - name: Push artifacts to DVC remote
      run: dvc push
